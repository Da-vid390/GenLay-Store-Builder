<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Your Store - GenLay Store Maker</title>
  <style>
    /* Your existing CSS remains unchanged */
    * {
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f9f9f9;
      color: #222;
      margin: 0;
      padding: 0;
      line-height: 1.6;
    }
    
    header {
      background: #25D366;
      color: white;
      padding: 1.5rem 1rem;
      text-align: center;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    header h1 {
      font-size: 1.8rem;
      margin: 0;
    }
    
    .container {
      max-width: 900px;
      margin: 2rem auto;
      padding: 0 1rem;
    }
    
    .progress-bar {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    
    .progress-steps {
      display: flex;
      justify-content: space-between;
      margin-bottom: 1rem;
    }
    
    .step {
      flex: 1;
      text-align: center;
      padding: 0.5rem;
      border-radius: 20px;
      margin: 0 0.2rem;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .step.active {
      background: #25D366;
      color: white;
    }
    
    .step.completed {
      background: #128C7E;
      color: white;
    }
    
    .step.inactive {
      background: #f0f0f0;
      color: #666;
    }
    
    .form-section {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 3px 15px rgba(0,0,0,0.08);
      border-left: 4px solid #25D366;
    }
    
    .form-section h2 {
      color: #25D366;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .bulk-import-area {
      background: #f8f9fa;
      border: 2px dashed #25D366;
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      margin: 1rem 0;
      transition: all 0.3s ease;
    }
    
    .bulk-import-area:hover {
      background: #f0f8f0;
      border-color: #128C7E;
    }
    
    .bulk-import-area.active {
      border-color: #25D366;
      background: #e8f5e8;
    }
    
    #bulkText {
      width: 100%;
      min-height: 200px;
      border: none;
      background: transparent;
      font-size: 1rem;
      resize: vertical;
      outline: none;
    }
    
    #bulkText::placeholder {
      color: #999;
      text-align: center;
    }
    
    .import-help {
      background: #e3f2fd;
      border-left: 4px solid #2196F3;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 0 8px 8px 0;
    }
    
    .import-examples {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .example-format {
      background: white;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
    }
    
    .example-format h4 {
      margin: 0 0 0.5rem 0;
      color: #25D366;
    }
    
    .example-format code {
      display: block;
      background: #f5f5f5;
      padding: 0.5rem;
      border-radius: 4px;
      white-space: pre-line;
      font-size: 0.8rem;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
      color: #333;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #25D366;
      box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.1);
    }
    
    .phone-input {
      display: flex;
      gap: 0.5rem;
    }
    
    .phone-input select {
      flex: 0 0 120px;
    }
    
    .phone-input input {
      flex: 1;
    }
    
    .theme-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin: 1rem 0;
    }
    
    .theme-option {
      border: 2px solid #ddd;
      border-radius: 10px;
      padding: 1rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }
    
    .theme-option:hover {
      border-color: #25D366;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .theme-option.selected {
      border-color: #25D366;
      background: #f0f8f0;
    }
    
    .theme-preview {
      width: 100%;
      height: 80px;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
    }
    
    .theme-green .theme-preview { background: linear-gradient(135deg, #25D366, #128C7E); }
    .theme-blue .theme-preview { background: linear-gradient(135deg, #2196F3, #1976D2); }
    .theme-purple .theme-preview { background: linear-gradient(135deg, #9C27B0, #7B1FA2); }
    .theme-orange .theme-preview { background: linear-gradient(135deg, #FF9800, #F57C00); }
    .theme-pink .theme-preview { background: linear-gradient(135deg, #E91E63, #C2185B); }
    .theme-dark .theme-preview { background: linear-gradient(135deg, #424242, #212121); }
    
    .product-preview {
      background: #f8f9fa;
      border-radius: 10px;
      padding: 1.5rem;
      margin: 1rem 0;
    }
    
    .product-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    
    .product-card {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: space-between;
      min-height: 180px; /* Ensure cards have enough space for image/upload */
    }
    
    .product-card .remove-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff4444;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .product-card .upload-btn-container {
        position: absolute;
        top: 5px;
        left: 5px;
        z-index: 10;
    }
    .product-card .upload-btn-container input[type="file"] {
        display: none; /* Hide the default file input */
    }

    .product-card .upload-icon {
        background: #2196F3; /* A blue color for upload */
        color: white;
        border: none;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .product-card .upload-icon:hover {
        background: #1976D2;
    }
    .product-card .upload-icon.loading {
      background: #ccc;
      border-top: 3px solid #25D366;
      animation: spin 1s linear infinite;
    }
    
    .product-card .product-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      color: #999;
    }
    .product-card .product-image img {
        width: 100%;
        height: 100%;
        border-radius: 8px;
    }
    .product-card .product-image.placeholder {
        /* Styles for the "No Image" text or icon */
        font-size: 0.8rem;
        text-align: center;
        line-height: 1.2;
        padding: 5px;
    }


    .product-card h4 {
      margin: 0 0 0.5rem 0;
      color: #333;
      font-size: 0.9rem;
      text-align: center;
    }
    
    .product-card .price {
      color: #25D366;
      font-weight: bold;
    }
    
    .limit-warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
      text-align: center;
    }
    
    .limit-warning.danger {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
    
    .action-buttons {
      display: flex;
      gap: 1rem;
      margin-top: 2rem;
      flex-wrap: wrap;
    }
    
    .btn {
      flex: 1;
      padding: 1rem 2rem;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      min-width: 150px;
    }
    
    .btn-primary {
      background: #25D366;
      color: white;
    }
    
    .btn-primary:hover {
      background: #128C7E;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
    }
    
    .btn-secondary {
      background: #f8f9fa;
      color: #333;
      border: 2px solid #ddd;
    }
    
    .btn-secondary:hover {
      background: #e9ecef;
      border-color: #25D366;
    }
    
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }
    
    .success-message {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      text-align: center;
    }
    
    .error-message {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
      padding: 1rem;
      border-radius: 8px;
      margin: 1rem 0;
      text-align: center;
    }
    
    .hidden {
      display: none;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 0 0.5rem;
      }
      
      .form-section {
        padding: 1.5rem;
      }
      
      .import-examples {
        grid-template-columns: 1fr;
      }
      
      .theme-selector {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        min-width: auto;
      }
      
      .phone-input {
        flex-direction: column;
      }
      
      .phone-input select {
        flex: none;
      }
    }
    
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #25D366;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <h1>üöÄ Create Your WhatsApp Store</h1>
  </header>

  <div class="container">
    <!-- Progress Bar -->
    <div class="progress-bar">
      <div class="progress-steps">
        <div class="step active" id="step1">üìã Import Products</div>
        <div class="step inactive" id="step2">‚öôÔ∏è Store Settings</div>
        <div class="step inactive" id="step3">üé® Customize</div>
        <div class="step inactive" id="step4">üöÄ Launch</div>
      </div>
    </div>

    <!-- Step 1: Bulk Import -->
    <div class="form-section" id="section1">
      <h2>üìã Import Your Products</h2>
      
      <div class="import-help">
        <strong>üí° Pro Tip:</strong> Copy your WhatsApp catalog and paste it below. We'll automatically parse your products!
      </div>

      <div class="import-examples">
        <div class="example-format">
          <h4>üì± WhatsApp Style</h4>
          <code>1. Ankara Dress - ‚Ç¶8,000
2. Handmade Bag - ‚Ç¶5,000  
3. Men's Watch - ‚Ç¶15,000</code>
        </div>
        <div class="example-format">
          <h4>üìù Simple List</h4>
          <code>Ankara Dress ‚Ç¶8,000
Handmade Bag ‚Ç¶5,000
Men's Watch ‚Ç¶15,000</code>
        </div>
        <div class="example-format">
          <h4>üí∞ Price After</h4>
          <code>Ankara Dress - Price: ‚Ç¶8,000
Handmade Bag - Price: ‚Ç¶5,000
Men's Watch - Price: ‚Ç¶15,000</code>
        </div>
      </div>

      <div class="bulk-import-area">
        <textarea 
          id="bulkText" 
          placeholder="üìã Paste your product list here...

Example:
1. Ankara Dress - ‚Ç¶8,000
2. Handmade Bag - ‚Ç¶5,000  
3. Men's Watch - ‚Ç¶15,000

We support multiple formats - just paste and we'll figure it out! ‚ú®"
        ></textarea>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="parseProductsBtn">
          <span id="parseBtn">üîÑ Parse Products</span>
        </button>
        <button class="btn btn-secondary" id="addManualProductBtn">‚ûï Add Product Manually</button>
      </div>
    </div>

    <!-- Product Preview -->
    <div class="form-section hidden" id="productPreview">
      <h2>üì¶ Your Products</h2>
      <div id="limitWarning" class="limit-warning hidden">
        <strong>‚ö†Ô∏è Free Plan Limit:</strong> You can add up to 10 products. <a href="#upgrade">Upgrade to Premium</a> for unlimited products.
      </div>
      <div class="product-preview">
        <div id="productGrid" class="product-grid">
          <!-- Products will be inserted here -->
        </div>
      </div>
    </div>

    <!-- Step 2: Store Settings -->
    <div class="form-section hidden" id="section2">
      <h2>‚öôÔ∏è Store Settings</h2>
      
      <div class="form-group">
        <label for="storeName">üè™ Store Name</label>
        <input type="text" id="storeName" placeholder="e.g., Jane's Collections" required>
      </div>

      <div class="form-group">
        <label for="storeUrl">üîó Store URL</label>
        <div style="display: flex; align-items: center; gap: 0.5rem;">
          <span style="color: #666;">yourstore.app/</span>
          <input type="text" id="storeUrl" placeholder="jane-collections" style="flex: 1;" required>
        </div>
        <small style="color: #666;">Only letters, numbers, and hyphens allowed (e.g., jane-collections)</small>
      </div>

      <div class="form-group">
        <label for="whatsappNumber">üì± WhatsApp Number</label>
        <div class="phone-input">
          <select id="countryCode">
            <option value="+234">üá≥üá¨ +234</option>
            <option value="+233">üá¨üá≠ +233</option>
            <option value="+254">üá∞üá™ +254</option>
            <option value="+27">üáøüá¶ +27</option>
            <option value="+1">üá∫üá∏ +1</option>
            <option value="+44">üá¨üáß +44</option>
            <option value="+0">Other</option>
          </select>
          <input type="tel" id="whatsappNumber" placeholder="8012345678" required>
        </div>
      </div>

      <div class="form-group">
        <label for="storeDescription">üìù Store Description (Optional)</label>
        <textarea id="storeDescription" rows="3" placeholder="Tell customers about your store..."></textarea>
      </div>
    </div>

    <!-- Step 3: Customize Theme -->
    <div class="form-section hidden" id="section3">
      <h2>üé® Choose Your Theme</h2>
      
      <div class="theme-selector">
        <div class="theme-option theme-green selected" data-theme="green">
          <div class="theme-preview">WhatsApp</div>
          <div>Classic Green</div>
        </div>
        <div class="theme-option theme-blue" data-theme="blue">
          <div class="theme-preview">Ocean</div>
          <div>Ocean Blue</div>
        </div>
        <div class="theme-option theme-purple" data-theme="purple">
          <div class="theme-preview">Royal</div>
          <div>Royal Purple</div>
        </div>
        <div class="theme-option theme-orange" data-theme="orange">
          <div class="theme-preview">Sunset</div>
          <div>Sunset Orange</div>
        </div>
        <div class="theme-option theme-pink" data-theme="pink">
          <div class="theme-preview">Rose</div>
          <div>Rose Pink</div>
        </div>
        <div class="theme-option theme-dark" data-theme="dark">
          <div class="theme-preview">Dark</div>
          <div>Dark Mode</div>
        </div>
      </div>
    </div>

    <!-- Step 4: Launch -->
    <div class="form-section hidden" id="section4">
      <h2>üöÄ Launch Your Store</h2>
      
      <div class="form-group">
        <label>üìä Plan Selection</label>
        <div style="display: flex; gap: 1rem; margin: 1rem 0;">
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="plan" value="free" checked>
            <span>üÜì Free (10 products)</span>
          </label>
          <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
            <input type="radio" name="plan" value="premium">
            <span>‚≠ê Premium (Unlimited + Custom Domain)</span>
          </label>
        </div>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" id="createStoreBtn">
          <span id="createBtn">üöÄ Create My Store</span>
        </button>
        <button class="btn btn-secondary" id="previewStoreBtn">üëÄ Preview First</button>
      </div>
    </div>

    <!-- Navigation Buttons -->
    <div class="action-buttons" id="navigationButtons" style="position: sticky; bottom: 20px; background: white; padding: 1rem; border-radius: 10px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1);">
      <button class="btn btn-secondary hidden" id="prevBtn">‚¨ÖÔ∏è Previous</button>
      <button class="btn btn-primary" id="nextBtn">Next ‚û°Ô∏è</button>
    </div>
  </div>

  <script type="module">
    // Supabase Initialization
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.43.2/+esm';

    // IMPORTANT: Replace these with your actual Supabase project URL and anon key
    // You can find these in your Supabase project settings under 'API'.
    const SUPABASE_URL = 'https://eztixsxfgvlfvthxnzro.supabase.co'
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmcxMjM0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzgwNjQ0MDAsImV4cCI6MTk5MzYwMDQwMH0';

    // Verify if placeholder values are still in use
    if (SUPABASE_URL === 'https://eztixsxfgvlfvthxnzro.supabase.co' || SUPABASE_ANON_KEY === 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmcxMjM0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzgwNjQ0MDAsImV4cCI6MTk5MzYwMDQwMH0') {
        console.warn("Supabase credentials are placeholders. Please replace 'https://abcdefg1234.supabase.co' and 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlZmcxMjM0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE2NzgwNjQ0MDAsImV4cCI6MTk5MzYwMDQwMH0.your_dummy_anon_key_here' with your actual Supabase project URL and anon key for the app to connect to your database.");
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentUserId = null; 

    // Handle Supabase Authentication state changes
    supabase.auth.onAuthStateChange((event, session) => {
        if (session && session.user) {
            currentUserId = session.user.id;
            console.log("Supabase user authenticated:", currentUserId);
        } else {
            console.warn("No Supabase user session found. Database write operations may fail due to Row Level Security (RLS). For demonstration, a random ID will be used, but for real data persistence, implement Supabase authentication (e.g., using supabase.auth.signInAnonymously() or other methods).");
            // For local testing/demonstration without a full auth flow, generate a random ID
            currentUserId = crypto.randomUUID(); 
        }
    });

    // --- Utility to map theme names to hex colors ---
    const themeColors = {
      'green': '#25D366',
      'blue': '#2196F3',
      'purple': '#9C27B0',
      'orange': '#FF9800',
      'pink': '#E91E63',
      'dark': '#424242'
    };

    let currentStep = 1;
    let products = [];
    let selectedTheme = 'green';
    const maxFreeProducts = 10;

    // Supabase Storage Upload Function (provided by you previously)
    async function uploadProductImage(file, userId, tempProductId) {
      const fileExt = file.name.split('.').pop();
      // Use the tempProductId for the filename initially, until the product is saved to DB
      const fileName = `${userId}/${tempProductId}-${Date.now()}.${fileExt}`;
      
      const { data, error } = await supabase.storage
        .from('product-images')
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: false // Set to true if you want to overwrite existing files with the same name
        });

      if (error) {
        console.error("Supabase Storage Upload Error:", error.message);
        throw error;
      }

      // Get public URL
      const { data: { publicUrl } } = supabase.storage
        .from('product-images')
        .getPublicUrl(fileName);

      return publicUrl;
    }


    // Function to handle image upload for a specific product
    async function handleProductImageUpload(event) {
        const file = event.target.files[0];
        const productId = event.target.dataset.productId; // Retrieve product ID from data attribute
        if (!file || !productId) return;

        const uploadIcon = event.target.closest('.upload-btn-container').querySelector('.upload-icon');
        const originalIconHtml = uploadIcon.innerHTML;
        uploadIcon.innerHTML = '<span class="loading"></span>';
        uploadIcon.classList.add('loading');

        try {
            if (!currentUserId) {
                showMessage("User not authenticated. Cannot upload image.", "error");
                throw new Error("User not authenticated.");
            }

            // The productId here is a temporary frontend ID until the product is saved to DB
            const imageUrl = await uploadProductImage(file, currentUserId, productId);

            // Update the products array in local state
            const productIndex = products.findIndex(p => p.id == productId);
            if (productIndex > -1) {
                // For now, let's assume one image per product for simplicity in UI
                // If you want multiple, you'd push to the array: products[productIndex].image_urls.push(imageUrl);
                products[productIndex].image_urls = [imageUrl]; 
                updateProductPreview(); // Re-render the product list to show the new image
                showMessage('Image uploaded successfully!', 'success');
                saveFormData(); // Save the updated products array with image URL
            } else {
                showMessage('Product not found in list.', 'error');
            }
        } catch (error) {
            console.error('Image upload failed:', error.message);
            showMessage(`Image upload failed: ${error.message}`, 'error');
        } finally {
            uploadIcon.innerHTML = originalIconHtml;
            uploadIcon.classList.remove('loading');
            event.target.value = ''; // Clear the input so same file can be selected again
        }
    }


    // Step navigation
    function nextStep() {
      if (validateCurrentStep()) {
        if (currentStep < 4) {
          currentStep++;
          updateStepDisplay();
        }
      }
    }

    function previousStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
      }
    }

    function updateStepDisplay() {
      // Update progress steps
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        const section = document.getElementById(`section${i}`);
        
        if (i < currentStep) {
          step.className = 'step completed';
          section.classList.add('hidden');
        } else if (i === currentStep) {
          step.className = 'step active';
          section.classList.remove('hidden');
        } else {
          step.className = 'step inactive';
          section.classList.add('hidden');
        }
      }

      // Update navigation buttons
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      
      if (currentStep === 1) {
        prevBtn.classList.add('hidden');
      } else {
        prevBtn.classList.remove('hidden');
      }

      if (currentStep === 4) {
        nextBtn.classList.add('hidden');
      } else {
        nextBtn.classList.remove('hidden');
      }
    }

    function validateCurrentStep() {
      switch (currentStep) {
        case 1:
          if (products.length === 0) {
            showMessage('Please add at least one product to continue.', 'error');
            return false;
          }
          return true;
        case 2:
          const storeName = document.getElementById('storeName').value.trim();
          const storeUrl = document.getElementById('storeUrl').value.trim();
          const whatsappNumber = document.getElementById('whatsappNumber').value.trim();
          
          if (!storeName || !storeUrl || !whatsappNumber) {
            showMessage('Please fill in all required fields.', 'error');
            return false;
          }
          
          // Validation for storeUrl to match Supabase slug pattern (only letters, numbers, and hyphens)
          if (!/^[a-z0-9-]+$/.test(storeUrl)) {
            showMessage('Store URL can only contain lowercase letters, numbers, and hyphens (e.g., my-awesome-store).', 'error');
            return false;
          }
          
          return true;
        default:
          return true;
      }
    }

    // Product parsing
    function parseProducts() {
      const bulkText = document.getElementById('bulkText').value.trim();
      const parseBtn = document.getElementById('parseBtn'); // Changed to select the span for loading indicator
      
      if (!bulkText) {
        showMessage('Please paste your product list first.', 'error');
        return;
      }

      parseBtn.innerHTML = '<span class="loading"></span> Parsing...';
      
      // Simulate processing time
      setTimeout(() => {
        const lines = bulkText.split('\n').filter(line => line.trim());
        const newProducts = [];

        lines.forEach(line => {
          const product = parseProductLine(line.trim());
          if (product) {
            newProducts.push(product);
          }
        });

        if (newProducts.length > 0) {
          products = newProducts.slice(0, maxFreeProducts); // Limit to free plan
          updateProductPreview();
          showMessage(`Successfully parsed ${products.length} products!`, 'success');
          
          if (newProducts.length > maxFreeProducts) {
            showLimitWarning(newProducts.length);
          }
        } else {
          showMessage('Could not parse any products. Please check the format.', 'error');
        }

        parseBtn.innerHTML = 'üîÑ Parse Products';
      }, 1000);
    }

    function parseProductLine(line) {
      // Remove common prefixes
      line = line.replace(/^\d+\.\s*/, '').replace(/^-\s*/, '').trim();
      
      // Try different price patterns
      const patterns = [
        /^(.+?)\s*[-‚Äì‚Äî]\s*‚Ç¶?([0-9,]+)$/,        // "Product - ‚Ç¶5000"
        /^(.+?)\s*‚Ç¶([0-9,]+)$/,                  // "Product ‚Ç¶5000"  
        /^(.+?)\s*[Pp]rice:\s*‚Ç¶?([0-9,]+)$/,   // "Product Price: ‚Ç¶5000"
        /^(.+?)\s*\$([0-9,]+)$/,                 // "Product $50"
        /^(.+?)\s*([0-9,]+)\s*naira$/i,         // "Product 5000 naira"
      ];

      for (const pattern of patterns) {
        const match = line.match(pattern);
        if (match) {
          const name = match[1].trim();
          const price = match[2].replace(/,/g, '');
          
          if (name && price && !isNaN(price)) {
            return {
              id: Date.now() + Math.random(), // Unique ID for frontend management (temporary, will be overwritten by Supabase UUID)
              name: name,
              price: parseFloat(price), // Use parseFloat for price DECIMAL type
              currency: '‚Ç¶', // This is just for display on frontend, backend has 'USD' default
              image_urls: [] // Initialize with empty array for images
            };
          }
        }
      }

      return null;
    }

    function updateProductPreview() {
      const productGrid = document.getElementById('productGrid');
      const productPreview = document.getElementById('productPreview');
      
      if (products.length === 0) {
        productPreview.classList.add('hidden');
        return;
      }

      productPreview.classList.remove('hidden');
      
      productGrid.innerHTML = products.map(product => `
        <div class="product-card">
          <button class="remove-btn" data-product-id="${product.id}" title="Remove product">√ó</button>
          
          <div class="upload-btn-container">
            <label for="file-upload-${product.id}" class="upload-icon" title="Upload Image">üì∑</label>
            <input id="file-upload-${product.id}" type="file" accept="image/*" data-product-id="${product.id}">
          </div>

          <div class="product-image ${product.image_urls && product.image_urls.length > 0 ? '' : 'placeholder'}">
            ${product.image_urls && product.image_urls.length > 0 
                ? `<img src="${product.image_urls[0]}" alt="${product.name}" onerror="this.onerror=null;this.src='https://placehold.co/80x80/cccccc/333333?text=Image+Error';">` 
                : 'No Image'}
          </div>
          <h4>${product.name}</h4>
          <div class="price">${product.currency}${product.price.toLocaleString()}</div>
        </div>
      `).join('');

      // Attach event listeners after content is rendered
      document.querySelectorAll('.remove-btn').forEach(button => {
        button.addEventListener('click', (event) => {
          removeProduct(event.target.dataset.productId);
        });
      });
      document.querySelectorAll('input[type="file"][id^="file-upload-"]').forEach(input => {
        input.addEventListener('change', handleProductImageUpload);
      });
    }

    function removeProduct(productId) {
      products = products.filter(p => p.id != productId);
      updateProductPreview();
      hideLimitWarning();
      saveFormData(); // Save changes after product removal
    }

    function addManualProduct() {
      const name = prompt('Product name:');
      const price = prompt('Product price (numbers only):');
      
      if (name && price && !isNaN(price)) {
        if (products.length >= maxFreeProducts) {
          showLimitWarning(products.length + 1);
          return;
        }
        
        products.push({
          id: Date.now(), // Temporary ID
          name: name.trim(),
          price: parseFloat(price),
          currency: '‚Ç¶',
          image_urls: [] // Initialize with empty array
        });
        
        updateProductPreview();
        showMessage('Product added successfully!', 'success');
        saveFormData(); // Save changes after adding product
      }
    }

    function showLimitWarning(attemptedCount) {
      const warning = document.getElementById('limitWarning');
      warning.classList.remove('hidden');
      
      if (attemptedCount > maxFreeProducts) {
        warning.classList.add('danger');
        warning.innerHTML = `<strong>‚ö†Ô∏è Limit Reached:</strong> You tried to add ${attemptedCount} products, but free accounts are limited to ${maxFreeProducts}. <a href="#upgrade" style="color: #25D366; text-decoration: underline;">Upgrade to Premium</a> for unlimited products.`;
      }
    }

    function hideLimitWarning() {
      if (products.length < maxFreeProducts) {
        document.getElementById('limitWarning').classList.add('hidden');
      }
    }

    // Theme selection
    document.querySelectorAll('.theme-option').forEach(option => {
      option.addEventListener('click', function() {
        document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
        this.classList.add('selected');
        selectedTheme = this.dataset.theme;
        saveFormData(); // Save selected theme
      });
    });

    // Store creation - NOW WITH SUPABASE INTEGRATION
    async function createStore() {
        const createBtn = document.getElementById('createBtn');
        createBtn.innerHTML = '<span class="loading"></span> Creating Store...';
        document.getElementById('createStoreBtn').disabled = true; // Disable button

        if (!currentUserId) {
            showMessage("User ID not available. Supabase authentication is required for creating stores. Please log in or ensure your Supabase auth is configured.", "error");
            createBtn.innerHTML = 'üöÄ Create My Store';
            document.getElementById('createStoreBtn').disabled = false;
            return;
        }

        const storeName = document.getElementById('storeName').value.trim();
        const storeSlug = document.getElementById('storeUrl').value.trim();
        const countryCode = document.getElementById('countryCode').value;
        const whatsappNumber = document.getElementById('whatsappNumber').value.trim();
        const fullWhatsappNumber = countryCode === '+0' ? whatsappNumber : countryCode + whatsappNumber; 
        const storeDescription = document.getElementById('storeDescription').value.trim();
        const themeHexColor = themeColors[selectedTheme] || themeColors['green']; // Get hex color from map

        try {
            // 1. Create the Store record
            const { data: newStore, error: storeError } = await supabase
                .from('stores')
                .insert({
                    user_id: currentUserId, // Must match authenticated user's ID for RLS
                    store_name: storeName,
                    description: storeDescription,
                    whatsapp_number: fullWhatsappNumber,
                    currency: 'USD', 
                    store_slug: storeSlug,
                    logo_url: null, 
                    theme_color: themeHexColor,
                    is_active: true
                })
                .select(); 

            if (storeError) throw storeError;
            
            const storeId = newStore[0].id; // Get the ID of the newly created store
            console.log('Store created in Supabase:', newStore[0]);
            
            // 2. Add Products for the new store
            if (products.length > 0) {
                // Prepare products for insertion.
                const productsToInsert = products.map((product, index) => ({
                    store_id: storeId,
                    category_id: null, 
                    name: product.name,
                    description: null, 
                    price: product.price,
                    original_price: product.price, 
                    sku: null, 
                    image_urls: product.image_urls || [], // This will now include the uploaded URLs
                    is_featured: false,
                    is_active: true,
                    sort_order: index 
                }));

                const { error: productsError } = await supabase
                    .from('products')
                    .insert(productsToInsert);

                if (productsError) throw productsError;
                console.log(`Successfully added ${products.length} products to store ${storeId}.`);
            }
            
            showMessage('üéâ Store created successfully!', 'success');
            
            // Clear local storage draft after successful creation
            localStorage.removeItem('formDraft');

            setTimeout(() => {
                window.location.href = `shop.html?store=${storeSlug}`; 
            }, 2000);

        } catch (error) {
            console.error('Error creating store or products:', error);
            showMessage(`Error creating store: ${error.message}`, 'error');
            createBtn.innerHTML = 'üöÄ Create My Store'; 
            document.getElementById('createStoreBtn').disabled = false; 
        }
    }

    function previewStore() {
      // This function keeps its current behavior, saving to local storage for shop.html preview.
      const storeData = {
        name: document.getElementById('storeName').value.trim() || 'My Store',
        url: document.getElementById('storeUrl').value.trim() || 'preview',
        whatsapp: document.getElementById('countryCode').value + (document.getElementById('whatsappNumber').value.trim() || '1234567890'),
        description: document.getElementById('storeDescription').value.trim(),
        theme: selectedTheme,
        products: products
      };
      
      // Save preview data
      localStorage.setItem('previewStore', JSON.stringify(storeData));
      
      // Open preview in new tab
      window.open(`shop.html?store=preview&mode=preview`, '_blank');
    }

    // URL validation
    document.getElementById('storeUrl').addEventListener('input', function() {
      this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '');
      saveFormData(); 
    });

    // Auto-focus on bulk text area
    document.getElementById('bulkText').addEventListener('focus', function() {
      document.querySelector('.bulk-import-area').classList.add('active');
    });

    document.getElementById('bulkText').addEventListener('blur', function() {
      document.querySelector('.bulk-import-area').classList.remove('active');
    });

    // Utility functions
    function showMessage(message, type) {
      document.querySelectorAll('.success-message, .error-message').forEach(msg => msg.remove());
      
      const messageDiv = document.createElement('div');
      messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
      messageDiv.textContent = message;
      
      const currentSection = document.getElementById(`section${currentStep}`);
      currentSection.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.remove();
        }
      }, 5000);
    }

    // Auto-save form data
    function saveFormData() {
      const formData = {
        storeName: document.getElementById('storeName').value,
        storeUrl: document.getElementById('storeUrl').value,
        countryCode: document.getElementById('countryCode').value,
        whatsappNumber: document.getElementById('whatsappNumber').value,
        storeDescription: document.getElementById('storeDescription').value,
        selectedTheme: selectedTheme,
        products: products, // Save product data including image_urls
        currentStep: currentStep
      };
      
      localStorage.setItem('formDraft', JSON.stringify(formData));
    }

    function loadFormData() {
      const savedData = localStorage.getItem('formDraft');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          
          document.getElementById('storeName').value = data.storeName || '';
          document.getElementById('storeUrl').value = data.storeUrl || '';
          document.getElementById('countryCode').value = data.countryCode || '+234';
          document.getElementById('whatsappNumber').value = data.whatsappNumber || '';
          document.getElementById('storeDescription').value = data.storeDescription || '';
          
          if (data.selectedTheme) {
            selectedTheme = data.selectedTheme;
            document.querySelectorAll('.theme-option').forEach(opt => {
              opt.classList.toggle('selected', opt.dataset.theme === selectedTheme);
            });
          }
          
          if (data.products) {
            products = data.products;
            updateProductPreview(); // Update preview to show loaded images
          }
          
          if (data.currentStep && data.currentStep > 1) {
            currentStep = data.currentStep;
            updateStepDisplay();
          }
        } catch (e) {
          console.log('Could not load saved form data', e);
        }
      }
    }

    // Auto-save on input changes
    document.addEventListener('input', saveFormData);
    document.addEventListener('change', saveFormData);

    // DOMContentLoaded event listener to attach all other event listeners
    document.addEventListener('DOMContentLoaded', function() {
      loadFormData();
      updateStepDisplay(); 
      
      // Attach event listeners for buttons
      document.getElementById('parseProductsBtn').addEventListener('click', parseProducts);
      document.getElementById('addManualProductBtn').addEventListener('click', addManualProduct);
      document.getElementById('createStoreBtn').addEventListener('click', createStore);
      document.getElementById('previewStoreBtn').addEventListener('click', previewStore);
      document.getElementById('prevBtn').addEventListener('click', previousStep);
      document.getElementById('nextBtn').addEventListener('click', nextStep);

      // Event listener for bulk import area focus/blur
      document.querySelector('.bulk-import-area').addEventListener('click', () => {
        document.getElementById('bulkText').focus();
      });
      document.getElementById('bulkText').addEventListener('focus', function() {
        document.querySelector('.bulk-import-area').classList.add('active');
      });
      document.getElementById('bulkText').addEventListener('blur', function() {
        document.querySelector('.bulk-import-area').classList.remove('active');
      });

      // Event listeners for theme options (already attached above, but kept here for clarity of original intent)
      // document.querySelectorAll('.theme-option').forEach(option => {
      //   option.addEventListener('click', function() {
      //     document.querySelectorAll('.theme-option').forEach(opt => opt.classList.remove('selected'));
      //     this.classList.add('selected');
      //     selectedTheme = this.dataset.theme;
      //     saveFormData();
      //   });
      // });
      
      // Set up keyboard shortcuts
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey || e.metaKey) {
          switch(e.key) {
            case 'Enter':
              e.preventDefault();
              if (currentStep < 4) {
                nextStep();
              } else {
                createStore();
              }
              break;
            case 'ArrowRight':
              e.preventDefault();
              if (currentStep < 4) nextStep();
              break;
            case 'ArrowLeft':
              e.preventDefault();
              if (currentStep > 1) previousStep();
              break;
          }
        }
      });
    });

    // Example data for quick testing
    function loadExampleData() {
      document.getElementById('bulkText').value = `1. Ankara Dress - ‚Ç¶8,000
2. Handmade Leather Bag - ‚Ç¶5,000  
3. Men's Wrist Watch - ‚Ç¶15,000
4. African Print Shirt - ‚Ç¶3,500
5. Women's Sandals - ‚Ç¶4,200`;
      
      document.getElementById('storeName').value = 'Fashion Paradise';
      document.getElementById('storeUrl').value = 'fashion-paradise'; 
      document.getElementById('whatsappNumber').value = '8012345678';
      document.getElementById('storeDescription').value = 'Quality fashion items at affordable prices. Fast delivery nationwide!';
      
      parseProducts();
      saveFormData(); 
    }

    // Add quick load button for testing (remove in production)
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      const testButton = document.createElement('button');
      testButton.textContent = 'üß™ Load Test Data';
      testButton.className = 'btn btn-secondary';
      testButton.style.position = 'fixed';
      testButton.style.top = '10px';
      testButton.style.right = '10px';
      testButton.style.zIndex = '1000';
      testButton.onclick = loadExampleData;
      document.body.appendChild(testButton);
    }
  </script>
</body>
</html>
